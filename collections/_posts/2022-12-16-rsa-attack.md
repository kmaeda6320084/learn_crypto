---
title: RSA暗号の攻撃
tags: crypto rsa attack
last_modified: 2022-12-16
---

# 共通法攻撃 (Common Modulus Attack)

RSAは鍵生成において，ランダムな素数のペア`p, q`から法`N = pq`，`\phi(N) = (p - 1)(q - 1)`と互いに素なランダムな数`e < \phi(N)`，`d = e^{-1} \mod \phi(N)`を計算する．

このとき，素数`p, q`を使いまわして`e, d`のみを変えて複数の通信を行った場合に暗号文を解読できてしまう可能性がある．

この攻撃を共通法攻撃という. (複数の通信で同じ法`N = pq`を利用している)

## 平文の解読

二回の通信を行い，同じ平文$m$を暗号化した場合を考える．

それぞれの通信での暗号文は以下のようになる．

$$
\begin{align*}
c_1 &= m^{e_1} \mod N\\
c_2 &= m^{e_2} \mod N
\end{align*}
$$

$e_1$と$e_2$が互いに素であるとき，$ue_1 + ve_2 = 1$を満たす整数$u, v$が存在し，拡張ユークリッドの互除法で求めることができる．

$e_1, e_2 > 1$より，$u, v$はどちらかが正でもう一方は負になる．
以降は$u > 0, v < 0$とする．


$gcd(c_2, N) \neq 1$である場合，$c_2$は[脆弱な暗号文](#weak_code)であり$p, q$を計算できるため，以降は$gcd(c_2, N) = 1$とする．

$gcd(c_2, N) = 1$である場合，$c_2^{-1}$が存在して，拡張ユークリッドの互除法で計算できる．

以上より，$c_1, c_2^{-1}, u, v, N$は既知であるから，次の計算が可能で，

$$
\begin{align*}
    (c_1)^u(c_2^{-1})^{-v} &= (m^{e_1})^u((m^{e_2})^{-1})^{-v}\\
    &= m^{ue_1 + ve_2}\\
    &= m \mod N
\end{align*}
$$
> $v < 0$であるから$-v$を利用する必要がある．

となり，平文$m$を求めることができる．

## 秘密鍵の解読

Alice, Bobの二人のユーザが法$N$を同じとして鍵生成を行ったとする．

Aliceの公開鍵を$(N, e_A)$，秘密鍵を$d_A$とし，Bobの公開鍵を$(N, e_B)$，秘密鍵を$d_B$とする．

いまAliceは$e_Ad_A - 1$を計算でき, Bobの$e_B$を知ることができる．

よって，拡張ユークリッドの互除法で$e_Bx = 1 \mod (e_Ad_A - 1)$を満たす$x$を計算でき，この$x$はBobの秘密鍵の代用として利用できる．

### 証明
平文を$m$, 暗号文を$c = m^{e_B} \mod N$とする．

$x$の定義より$e_Bx = k (e_Ad_A - 1) + 1$となる整数$k$が存在する．

また，RSAの定義より$e_Ad_A = 1 \mod \phi(N)$であるから，$e_Ad_A = l\cdot\phi(N) + 1$となる整数$l$が存在する．

よって

$$
\begin{align*}
    c^x \mod N &= m^{e_Bx} \mod N\\
    &= m^{k(e_Ad_A - 1) + 1} \mod N\\
    &= m^{k(l\cdot\phi(N) + 1 - 1) + 1} \mod N\\
    &= m^{kl\cdot\phi(N) + 1} \mod N\\
    &= m \cdot m^{kl\cdot \phi(N)}\mod N\\
    &= m \mod N \quad (\because m^{\phi(N)} = 1 \mod N)
\end{align*}
$$


{:#weak_code}
# 脆弱な暗号文

法$N = pq$であるとき，暗号文$c$が$p, q$いずれかの倍数であると，容易に$N$から$p, q$を特定できる．

$c$が$p, q$いずれか一方の倍数であるとき，$g = gcd(c, N)$は
$$
\begin{align*}
    gcd(c, N) &= gcd(c, pq)\\
    &= p, q
\end{align*}
$$
となり，$p, q$を容易に特定できてしまう．

脆弱な暗号文が発生する確率は
$$
\frac{1}{p} + \frac{1}{q} - \frac{1}{pq} \quad (pで割り切る確率 + qで割り切る確率 - pqで割り切る確率)
$$
であり, $p, q$が大きくなればきわめて確率は小さくなる．

# 脆弱な素数

法$N = pq$であるとき，$|p - q|$が極端に大きい場合と小さな場合の両方で脆弱になる．

1. $|p - q|$が極端に大きい場合.

$N = pq$であるから$p = N / q$, $q = N / p$であり，
$|p - q|$が極端に大きいことは$p, q$の一方が小さいことになり，素因数分解が簡単であることを示している．

2. $|p - q|$が極端に小さい場合．

二次方程式$X^2 - (p + q)X +pq = 0$を考える．

この方程式の解は，解の公式より
$$
\begin{align*}
    X &= \frac{p + q \pm \sqrt{(p + q)^2 - 4pq}}{2}\\
    &= \frac{p + q \pm \sqrt{p^2 - 2pq + q^2}}{2}\\
    &= \frac{p + q \pm \sqrt{(p - q)^2}}{2}\\
    &= \frac{p + q \pm |p - q|}{2}\\
    &= p, q
\end{align*}
$$
であるから，$p + q$を求めることができれば容易に$p, q$を求めることができる．

$$
(p + q)^2 - (p - q)^2 = 4pq
$$
であり，$N= pq$であるから
$$
(p + q)^2 - (p - q)^2 = 4N
$$

$$
(p + q)^2  = 4N + (p - q)^2
$$

$$
p + q  = \sqrt{4N + (p - q)^2}
$$

いま，$p, q$は素数であるから，$p - q$は偶数で，$|p - q|$が小さい場合は$p + q$を容易に求めることができる．

$k$ビットの素数を利用している場合，

$$2^{k - 1} \leq p, q \leq 2^k - 1$$

を満たすから

$$2^{k - 1} \leq p, q \leq 2^k - 1$$

であり，

$$
2^{k - 1} - 2^k + 1 \leq p - q \leq 2^k - 2^{k - 1} - 1
$$

$$
|p - q|\leq |2^k - 2^{k - 1} - 1| = |2^{k - 1} - 1|
$$

となる．